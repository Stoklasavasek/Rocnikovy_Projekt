{% extends "base.html" %}
{% load wagtailcore_tags %}
{# Šablona pro finální výsledky živého sezení - zobrazuje podium a celkový žebříček #}

{% block content %}
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-8 text-center">Výsledky: {{ session.quiz.title }} ({{ session.code }})</h1>
  {# Tlačítko pro stažení výsledků do CSV (pouze pro učitele) #}
  {% if is_host %}
    <div class="flex justify-center mb-8">
      <a href="{% url 'session_results_csv' session.hash %}" class="btn-secondary px-6 py-3">Stáhnout CSV</a>
    </div>
  {% endif %}

  {% if leaderboard %}
    {# Podium - zobrazení prvních 3 míst #}
    <div class="podium-container">
      {% if leaderboard.1 %}<div class="podium-place second"><div class="podium-rank second">2. místo</div><div class="podium-name second">{{ leaderboard.1.participant.display_name }}</div><div class="podium-score">{{ leaderboard.1.score }} bodů</div></div>{% endif %}
      {% if leaderboard.0 %}<div class="podium-place first"><div class="podium-rank first">1. místo</div><div class="podium-name first">{{ leaderboard.0.participant.display_name }}</div><div class="podium-score first">{{ leaderboard.0.score }} bodů</div></div>{% endif %}
      {% if leaderboard.2 %}<div class="podium-place third"><div class="podium-rank third">3. místo</div><div class="podium-name third">{{ leaderboard.2.participant.display_name }}</div><div class="podium-score">{{ leaderboard.2.score }} bodů</div></div>{% endif %}
    </div>

    {# Celkový žebříček všech účastníků #}
    <div class="card-modern mb-8">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 text-center">Celkový žebříček</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
          <thead style="background: #000000 !important;">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase" style="color: #ffffff !important; font-weight: 700 !important; background: #000000 !important;">#</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase" style="color: #ffffff !important; font-weight: 700 !important; background: #000000 !important;">Účastník</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase" style="color: #ffffff !important; font-weight: 700 !important; background: #000000 !important;">Skóre</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-800">
            {% for item in leaderboard %}
            <tr class="{% if forloop.counter0 == 0 %}bg-yellow-50 dark:bg-yellow-900/20{% else %}hover:bg-gray-100/50 dark:hover:bg-gray-700/50{% endif %} transition-colors">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ forloop.counter }}.</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ item.participant.display_name }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white">{{ item.score }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    {# Vzdělávací materiály po kvízu (pouze pro studenty) #}
    {# Poznámka: Zobrazují se pod žebříčkem po skončení celého kvízu #}
    {% if not is_host and educational_materials_after %}
      <div class="card-modern mb-8" style="background: #1f2937 !important; border: 2px solid #374151 !important;">
        <h2 class="text-2xl font-bold mb-4" style="color: #f9fafb !important;">Vzdělávací materiály</h2>
        <p class="mb-4" style="color: #d1d5db !important;">Po skončení kvízu si můžete prostudovat následující materiály:</p>
        <ul class="material-list">
          {% for material in educational_materials_after %}
            <li class="material-item pad-sm bg-card rounded my-2">
              <div class="material-header" onclick="toggleMaterialAfter({{ forloop.counter0 }})">
                <div>
                  <h3><a href="{% pageurl material %}" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">{{ material.title }}</a></h3>
                  <p class="text-muted">
                    Typ: {{ material.get_material_type_display }}
                    {% if material.video_file %}
                      | <a href="{{ material.video_file.url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">Video soubor ↗</a>
                    {% elif material.document_file %}
                      | <a href="{{ material.document_file.url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">Dokument ↗</a>
                    {% elif material.external_url %}
                      | <a href="{{ material.external_url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">Externí odkaz ↗</a>
                    {% endif %}
                  </p>
                </div>
                <span class="material-toggle" id="toggle-after-{{ forloop.counter0 }}">▼</span>
              </div>
              {% if material.content %}
                <div class="material-content my-2" id="content-after-{{ forloop.counter0 }}">
                  {{ material.content|richtext }}
                </div>
              {% endif %}
              {% if material.video_file %}
                <div class="material-content my-2" id="content-after-{{ forloop.counter0 }}">
                  <video controls style="width: 100%; max-width: 800px;">
                    <source src="{{ material.video_file.url }}" type="video/mp4">
                    Váš prohlížeč nepodporuje video tag.
                  </video>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  {% else %}
    {# Zobrazení, pokud nejsou žádní účastníci #}
    <div class="empty-results">
      <strong>Konec kvízu.</strong>
      <p>Žádní účastníci.</p>
    </div>
  {% endif %}
</div>

{% if not is_host and educational_materials_after %}
<script>
// Poznámka: IIFE pattern pro izolaci scope a rozbalování/sbalování materiálů po kvízu
(function() {
  function toggle(prefix, index) {
    const content = document.getElementById(`content-${prefix}-${index}`);
    const toggle = document.getElementById(`toggle-${prefix}-${index}`);
    if (content && toggle) {
      const isHidden = content.style.display === 'none';
      content.style.display = isHidden ? 'block' : 'none';
      toggle.textContent = isHidden ? '▲' : '▼';
    }
  }
  window.toggleMaterialAfter = (index) => toggle('after', index);
})();
</script>
{% endif %}
{% endblock %}
