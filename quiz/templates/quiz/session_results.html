{% extends "base.html" %}
{% load wagtailcore_tags %}
{# ≈†ablona pro fin√°ln√≠ v√Ωsledky ≈æiv√©ho sezen√≠ - zobrazuje podium a celkov√Ω ≈æeb≈ô√≠ƒçek #}

{% block content %}
<div class="results-container">
  <h1>V√Ωsledky: {{ session.quiz.title }} ({{ session.code }})</h1>
  {# Tlaƒç√≠tko pro sta≈æen√≠ v√Ωsledk≈Ø do CSV (pouze pro uƒçitele) #}
  {% if is_host %}
    <p class="results-csv-link">
      <a href="{% url 'session_results_csv' session.hash %}" class="btn ghost">St√°hnout CSV</a>
    </p>
  {% endif %}

  {% if leaderboard %}
    {# Podium - zobrazen√≠ prvn√≠ch 3 m√≠st #}
    <div class="podium-container">
      {% if leaderboard.1 %}<div class="podium-place second"><div class="podium-rank second">2. m√≠sto</div><div class="podium-name second">{{ leaderboard.1.participant.display_name }}</div><div class="podium-score">{{ leaderboard.1.score }} bod≈Ø</div></div>{% endif %}
      {% if leaderboard.0 %}<div class="podium-place first"><div class="podium-rank first">1. m√≠sto</div><div class="podium-name first">{{ leaderboard.0.participant.display_name }}</div><div class="podium-score first">{{ leaderboard.0.score }} bod≈Ø</div></div>{% endif %}
      {% if leaderboard.2 %}<div class="podium-place third"><div class="podium-rank third">3. m√≠sto</div><div class="podium-name third">{{ leaderboard.2.participant.display_name }}</div><div class="podium-score">{{ leaderboard.2.score }} bod≈Ø</div></div>{% endif %}
    </div>

    {# Celkov√Ω ≈æeb≈ô√≠ƒçek v≈°ech √∫ƒçastn√≠k≈Ø #}
    <div class="leaderboard-section">
      <h2 class="leaderboard-title">Celkov√Ω ≈æeb≈ô√≠ƒçek</h2>
      <table class="results-table">
        <thead>
          <tr>
            <th>#</th>
            <th>√öƒçastn√≠k</th>
            <th>Sk√≥re</th>
          </tr>
        </thead>
        <tbody>
          {% for item in leaderboard %}
          <tr{% if forloop.counter0 == 0 %} class="correct-answer-row"{% endif %}>
            <td>{{ forloop.counter }}.</td>
            <td>{{ item.participant.display_name }}</td>
            <td>{{ item.score }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    {# Vzdƒõl√°vac√≠ materi√°ly po kv√≠zu (pouze pro studenty) #}
    {# Pozn√°mka: Zobrazuj√≠ se pod ≈æeb≈ô√≠ƒçkem po skonƒçen√≠ cel√©ho kv√≠zu #}
    {% if not is_host and educational_materials_after %}
      <div class="educational-materials card pad my-4">
        <h2>üìö Vzdƒõl√°vac√≠ materi√°ly</h2>
        <p class="text-muted">Po skonƒçen√≠ kv√≠zu si m≈Ø≈æete prostudovat n√°sleduj√≠c√≠ materi√°ly:</p>
        <ul class="material-list">
          {% for material in educational_materials_after %}
            <li class="material-item pad-sm bg-card rounded my-2">
              <div class="material-header" onclick="toggleMaterialAfter({{ forloop.counter0 }})">
                <div>
                  <h3><a href="{% pageurl material %}" onclick="event.stopPropagation();">{{ material.title }}</a></h3>
                  <p class="text-muted">
                    Typ: {{ material.get_material_type_display }}
                    {% if material.external_url %}
                      | <a href="{{ material.external_url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">Extern√≠ odkaz ‚Üó</a>
                    {% endif %}
                  </p>
                </div>
                <span class="material-toggle" id="toggle-after-{{ forloop.counter0 }}">‚ñº</span>
              </div>
              {% if material.content %}
                <div class="material-content my-2" id="content-after-{{ forloop.counter0 }}">
                  {{ material.content|richtext }}
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  {% else %}
    {# Zobrazen√≠, pokud nejsou ≈æ√°dn√≠ √∫ƒçastn√≠ci #}
    <div class="empty-results">
      <strong>Konec kv√≠zu.</strong>
      <p>≈Ω√°dn√≠ √∫ƒçastn√≠ci.</p>
    </div>
  {% endif %}
</div>

{% if not is_host and educational_materials_after %}
<script>
// Pozn√°mka: IIFE pattern pro izolaci scope a rozbalov√°n√≠/sbalov√°n√≠ materi√°l≈Ø po kv√≠zu
(function() {
  function toggle(prefix, index) {
    const content = document.getElementById(`content-${prefix}-${index}`);
    const toggle = document.getElementById(`toggle-${prefix}-${index}`);
    if (content && toggle) {
      const isHidden = content.style.display === 'none';
      content.style.display = isHidden ? 'block' : 'none';
      toggle.textContent = isHidden ? '‚ñ≤' : '‚ñº';
    }
  }
  window.toggleMaterialAfter = (index) => toggle('after', index);
})();
</script>
{% endif %}
{% endblock %}
