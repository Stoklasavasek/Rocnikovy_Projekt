{% extends "base.html" %}
{% load quiz_tags %}
{% block content %}
<div style="max-width:800px;margin:24px auto;padding:0 16px;">
  <h1>{{ session.quiz.title }}</h1>
  <h2>Otázka {{ qrun.order }}: {{ qrun.question.text }}</h2>
  {% if remaining %}
    <p>Zbývající čas: {{ remaining }} s</p>
  {% endif %}
  <script>
    (function() {
      const hash = "{{ session.hash }}";
      const currentOrder = {{ qrun.order }};
      const isHost = {{ is_host|yesno:"true,false" }};
      async function tick() {
        try {
          const res = await fetch("{% url 'session_status' session.hash %}", { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if (!res.ok) return;
          const data = await res.json();
          if (data.state === 'finished') {
            window.location.href = "{% url 'session_results' session.hash %}";
            return;
          }
          if (data.state === 'question' && data.order !== currentOrder) {
            window.location.href = "/session/" + hash + "/q/" + data.order + "/";
            return;
          }
          if (data.state === 'waiting') {
            window.location.href = "{% url 'session_lobby' session.hash %}";
          }
          // Pro učitele: obnovit stránku každé 3 sekundy pro aktualizaci statistik
          if (isHost && data.state === 'question' && data.order === currentOrder) {
            // Stránka se obnoví automaticky při dalším ticku
          }
        } catch (e) { /* ignore */ }
      }
      setInterval(tick, {% if is_host %}3000{% else %}2000{% endif %});
      // Pro učitele: obnovit stránku každých 5 sekund pro aktualizaci statistik
      {% if is_host %}
      setTimeout(function() {
        if (document.visibilityState === 'visible') {
          location.reload();
        }
      }, 5000);
      {% endif %}
    })();
  </script>
  {% if is_host %}
    <div style="margin:16px 0; padding:16px; background:#f7f7f7; border-radius:8px;">
      <h3>Statistiky odpovědí</h3>
      <p><strong>Odpovědělo: {{ answered_count }} / {{ total_participants }}</strong></p>
      
      {% if all_answered %}
      <div style="margin-top:20px; padding:16px; background:#fff; border-radius:8px;">
        <h4 style="margin-top:0;">Výsledky podle odpovědí:</h4>
        <ul style="list-style:none; padding:0;">
          {% for answer in qrun.question.answers.all %}
            {% with stats=answer_stats|get_item:answer.id %}
            <li style="margin:12px 0; padding:12px; {% if answer.is_correct %}background:#e8f5e9; border-left:4px solid #4CAF50;{% else %}background:#f9f9f9; border-left:4px solid #2196F3;{% endif %} border-radius:6px;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <strong>{{ answer.text }}</strong>
                  {% if answer.is_correct %}
                    <span style="color:#2e7d32; margin-left:8px; font-size:18px;">✓</span>
                  {% endif %}
                </div>
                <div style="font-size:24px; font-weight:bold; {% if answer.is_correct %}color:#2e7d32;{% else %}color:#2196F3;{% endif %}">
                  {% if stats %}{{ stats.count }}{% else %}0{% endif %}
                </div>
              </div>
            </li>
            {% endwith %}
          {% endfor %}
        </ul>
      </div>
      
      {% if participant_responses %}
      <div style="margin-top:20px;">
        <h4 style="margin-top:0;">Kdo jak odpověděl:</h4>
        
        {% if correct_responses %}
        <div style="margin-top:20px; padding:16px; background:#e8f5e9; border-radius:8px; border:2px solid #4CAF50;">
          <h5 style="margin-top:0; color:#2e7d32;">✓ Správně odpověděli:</h5>
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:2px solid #4CAF50;">
                <th style="text-align:left; padding:8px;">Účastník</th>
                <th style="text-align:left; padding:8px;">Odpověď</th>
              </tr>
            </thead>
            <tbody>
              {% for response in correct_responses %}
              <tr style="border-bottom:1px solid #c8e6c9;">
                <td style="padding:8px;">{{ response.participant.display_name }}</td>
                <td style="padding:8px;">{{ response.answer.text }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
        
        {% if wrong_responses %}
        <div style="margin-top:20px; padding:16px; background:#ffebee; border-radius:8px; border:2px solid #f44336;">
          <h5 style="margin-top:0; color:#c62828;">✗ Špatně odpověděli:</h5>
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:2px solid #f44336;">
                <th style="text-align:left; padding:8px;">Účastník</th>
                <th style="text-align:left; padding:8px;">Odpověď</th>
              </tr>
            </thead>
            <tbody>
              {% for response in wrong_responses %}
              <tr style="border-bottom:1px solid #ffcdd2;">
                <td style="padding:8px;">{{ response.participant.display_name }}</td>
                <td style="padding:8px;">{{ response.answer.text }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </div>
      {% endif %}
      {% else %}
      <div style="margin-top:20px; padding:16px; background:#fff3cd; border-radius:8px; border-left:4px solid #ffc107;">
        <p style="margin:0; color:#856404;">Statistiky se zobrazí až poté, co všichni účastníci odpoví.</p>
      </div>
      {% endif %}
      
      {% if all_answered or remaining == 0 %}
        <div style="margin-top:20px; padding-top:16px; border-top:2px solid #ddd;">
          {% if next_exists %}
            <a href="{% url 'session_start_question' session.hash qrun.order|add:1 %}" 
               style="display:inline-block; padding:12px 24px; background:#4CAF50; color:white; text-decoration:none; border-radius:6px; font-weight:bold;">
              Přejít na další otázku
            </a>
          {% else %}
            <a href="{% url 'session_finish' session.hash %}" 
               style="display:inline-block; padding:12px 24px; background:#f44336; color:white; text-decoration:none; border-radius:6px; font-weight:bold;">
              Ukončit sezení
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% else %}
    {% if has_answered %}
      <div style="margin:16px 0; padding:12px; background:#f0f0f0; border-radius:8px;">
        <p>Odpověď přijata. Čekejte, než odpoví ostatní studenti nebo učitel spustí další otázku.</p>
      </div>
    {% else %}
    <form action="{% url 'session_submit_answer' session.hash qrun.order %}" method="post">
      {% csrf_token %}
      <ul>
        {% for a in qrun.question.answers.all %}
          <li>
            <label>
              <input type="radio" name="answer_id" value="{{ a.id }}" required>
              {{ a.text }}
            </label>
          </li>
        {% endfor %}
      </ul>
      <button type="submit">Odeslat</button>
    </form>
    {% endif %}
  {% endif %}
</div>
{% endblock %}

