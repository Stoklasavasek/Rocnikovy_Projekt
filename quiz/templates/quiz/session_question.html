{% extends "base.html" %}
{% load quiz_tags %}
{% block content %}
<div class="container quiz-container">
  <div class="quiz-icon">ğŸ“š</div>
  <h1 class="quiz-title">{{ session.quiz.title }}</h1>
  <h2 class="quiz-question">â“ OtÃ¡zka {{ qrun.order }}: {{ qrun.question.text }}</h2>
  {% if remaining %}
    <p class="timer-display">â± ZbÃ½vajÃ­cÃ­ Äas: <span class="remaining-time">{{ remaining }}</span> s <span id="timer-status" class="timer-status"></span></p>
  {% endif %}
  <script>
    (function() {
      // Pro uÄitele: OKAMÅ½ITÄš spustit auto-refresh
      {% if is_host and not all_answered %}
      setInterval(function() {
        location.reload();
      }, 1000);
      {% endif %}
      
      // OKAMÅ½ITÄš spustit timer - pÅ™ed vÅ¡Ã­m ostatnÃ­m!
      (function() {
        const remainingEl = document.querySelector('.remaining-time');
        const timerStatusEl = document.getElementById('timer-status');
        let timerInterval = null;
        
        if (remainingEl) {
          let currentTime = parseInt(remainingEl.textContent.trim()) || 0;
          
          if (timerStatusEl) {
            timerStatusEl.textContent = 'Timer bÄ›Å¾Ã­';
          }
          
          // Funkce pro zastavenÃ­ timeru
          function stopTimer() {
            if (timerInterval) {
              clearInterval(timerInterval);
              timerInterval = null;
            }
            if (timerStatusEl) {
              timerStatusEl.textContent = 'Timer zastaven';
              timerStatusEl.style.color = 'gray';
            }
          }
          
          // Zkontrolovat, jestli uÅ¾ jsou zobrazenÃ© vÃ½sledky (vÅ¡ichni odpovÄ›dÄ›li nebo Äas vyprÅ¡el)
          function checkIfResultsShown() {
            {% if is_host %}
            // Pro uÄitele: zkontrolovat, jestli je viditelnÃ¡ sekce s vÃ½sledky
            const statsSection = document.querySelector('.stats-section');
            if (statsSection && statsSection.style.opacity !== '0.7') {
              // Sekce s vÃ½sledky je viditelnÃ¡ (opacity nenÃ­ 0.7, coÅ¾ znamenÃ¡, Å¾e vÅ¡ichni odpovÄ›dÄ›li)
              stopTimer();
              return true;
            }
            {% endif %}
            return false;
          }
          
          // Pokud uÅ¾ jsou vÃ½sledky zobrazenÃ© pÅ™i naÄtenÃ­ strÃ¡nky, zastavit timer
          if (checkIfResultsShown()) {
            return;
          }
          
          // UloÅ¾it referenci na stopTimer do window, aby bylo moÅ¾nÃ© ji volat z jinÃ½ch handlerÅ¯
          window.stopTimerIfRunning = stopTimer;
          
          timerInterval = setInterval(function() {
            // Zkontrolovat, jestli uÅ¾ jsou zobrazenÃ© vÃ½sledky
            if (checkIfResultsShown()) {
              return;
            }
            
            if (currentTime > 0) {
              currentTime = currentTime - 1;
              remainingEl.textContent = currentTime;
              if (timerStatusEl) {
                timerStatusEl.style.opacity = timerStatusEl.style.opacity === '0.5' ? '1' : '0.5';
              }
            } else {
              stopTimer();
              if (timerStatusEl) {
                timerStatusEl.textContent = 'â± ÄŒas vyprÅ¡el';
                timerStatusEl.style.color = 'red';
              }
            }
          }, 1000);
        } else {
          if (timerStatusEl) {
            timerStatusEl.textContent = 'âœ— Timer nenalezen';
            timerStatusEl.style.color = 'red';
          }
        }
      })();
      
      const hash = "{{ session.hash }}";
      const currentOrder = {{ qrun.order }};
      const isHost = {{ is_host|yesno:"true,false" }};
      
      // Zkontrolovat, jestli je socket.io naÄtenÃ½
      if (typeof io === 'undefined') {
        console.error('Socket.IO library not loaded!');
        // Fallback na polling
        const fallback = setInterval(async function() {
          try {
            const res = await fetch("{% url 'session_status' session.hash %}", { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) return;
            const data = await res.json();
            if (data.state === 'finished') {
              clearInterval(fallback);
              window.location.href = "{% url 'session_results' session.hash %}";
            } else if (data.state === 'question' && data.order !== currentOrder) {
              clearInterval(fallback);
              window.location.href = "/session/" + hash + "/q/" + data.order + "/";
            } else if (data.state === 'waiting') {
              clearInterval(fallback);
              window.location.href = "{% url 'session_lobby' session.hash %}";
            }
          } catch (e) { /* ignore */ }
        }, 2000);
        return;
      }
      
      const socket = io('http://localhost:8001', {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 500,
        reconnectionAttempts: 10
      });
      
      {% if is_host %}
      socket.on('answer_update', function(data) {
        if (data.question_order === currentOrder) {
          location.reload();
        }
      });
      {% else %}
      socket.on('disconnect', function() {
        // Fallback na polling pro studenty pokud socket.io selÅ¾e
        const fallback = setInterval(async function() {
          try {
            const res = await fetch("{% url 'session_status' session.hash %}", { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            if (!res.ok) return;
            const data = await res.json();
            if (data.state === 'finished') {
              clearInterval(fallback);
              window.location.href = "{% url 'session_results' session.hash %}";
            } else if (data.state === 'question' && data.order !== currentOrder) {
              clearInterval(fallback);
              window.location.href = "/session/" + hash + "/q/" + data.order + "/";
            } else if (data.state === 'waiting') {
              clearInterval(fallback);
              window.location.href = "{% url 'session_lobby' session.hash %}";
            }
          } catch (e) { /* ignore */ }
        }, 2000);
      });
      {% endif %}
      
      socket.on('connect', function() {
        socket.emit('join_session', {hash: hash});
      });
      
      socket.on('session_state', function(data) {
        if (data.state === 'finished') {
          window.location.href = "{% url 'session_results' session.hash %}";
          return;
        }
        if (data.state === 'question') {
          if (data.order !== currentOrder) {
            // PÅ™esmÄ›rovat na jinou otÃ¡zku
            window.location.href = "/session/" + hash + "/q/" + data.order + "/";
            return;
          } else {
            // Pokud je student uÅ¾ na sprÃ¡vnÃ© otÃ¡zce, ale otÃ¡zka prÃ¡vÄ› zaÄala, obnovit strÃ¡nku
            // aby se zobrazil formulÃ¡Å™ (pokud jeÅ¡tÄ› neodpovÄ›dÄ›l)
            {% if not is_host and not has_answered %}
            if (!document.querySelector('form[action*="submit"]')) {
              location.reload();
            }
            {% endif %}
          }
        }
        if (data.state === 'waiting') {
          window.location.href = "{% url 'session_lobby' session.hash %}";
        }
      });
    })();
  </script>
  {% if is_host %}
    <div class="card pad stats-card">
      <h3>ğŸ“Š Statistiky odpovÄ›dÃ­</h3>
      <p><strong>OdpovÄ›dÄ›lo: <span class="answered-count stats-badge">{{ answered_count }}</span> / <span class="stats-badge">{{ total_participants }}</span></strong></p>
      
      {% if all_answered %}
      <div class="stats-section" style="margin-top:20px; padding:20px; background:linear-gradient(135deg,#fff 0%,#f9fafb 100%); border-radius:12px; border:2px solid var(--border);">
        <h4>âœ… VÃ½sledky podle odpovÄ›dÃ­:</h4>
        <ul style="list-style:none; padding:0;">
          {% for answer in qrun.question.answers.all %}
            {% with stats=answer_stats|get_item:answer.id %}
            <li data-answer-id="{{ answer.id }}" class="answer-item {% if answer.is_correct %}correct{% else %}wrong{% endif %}">
              <div style="display:flex; justify-content:space-between; align-items:center;flex-wrap:wrap;gap:8px;">
                <div style="flex:1;min-width:200px;">
                  <strong>{{ answer.text }}</strong>
                  {% if answer.is_correct %}
                    <span style="color:#2e7d32; margin-left:8px; font-size:18px;">âœ“</span>
                  {% endif %}
                </div>
                <div class="stats-number" style="font-size:clamp(20px, 4vw, 24px); font-weight:bold; {% if answer.is_correct %}color:#2e7d32;{% else %}color:#2196F3;{% endif %}">
                  {% if stats %}{{ stats.count }}{% else %}0{% endif %}
                </div>
              </div>
            </li>
            {% endwith %}
          {% endfor %}
        </ul>
      </div>
      {% else %}
      {# Zobrazit zÃ¡kladnÃ­ statistiky i kdyÅ¾ jeÅ¡tÄ› neodpovÄ›dÄ›li vÅ¡ichni - BEZ zobrazenÃ­ sprÃ¡vnÃ© odpovÄ›di #}
      <div class="stats-section waiting" style="margin-top:20px; padding:20px; background:linear-gradient(135deg,#f3f4f6 0%,#e5e7eb 100%); border-radius:12px; border:2px solid var(--border); opacity:0.9;">
        <h4>â³ PrÅ¯bÄ›Å¾nÃ© vÃ½sledky:</h4>
        <ul style="list-style:none; padding:0;">
          {% for answer in qrun.question.answers.all %}
            {% with stats=answer_stats|get_item:answer.id %}
            <li data-answer-id="{{ answer.id }}" class="answer-item waiting">
              <div style="display:flex; justify-content:space-between; align-items:center;flex-wrap:wrap;">
                <div>
                  <strong>{{ answer.text }}</strong>
                  {# NESMÃ se zobrazit sprÃ¡vnÃ¡ odpovÄ›Ä pÅ™ed skonÄenÃ­m otÃ¡zky #}
                </div>
                <div class="stats-number" style="font-size:clamp(20px, 4vw, 24px); font-weight:bold; color:#2196F3;">
                  {% if stats %}{{ stats.count }}{% else %}0{% endif %}
                </div>
              </div>
            </li>
            {% endwith %}
          {% endfor %}
        </ul>
        <p style="margin-top:12px; font-style:italic; color:#666;">ÄŒekÃ¡me na odpovÄ›di vÅ¡ech ÃºÄastnÃ­kÅ¯...</p>
      </div>
      {% endif %}
      
      {% if participant_responses %}
      <div style="margin-top:20px;">
        <h4 style="margin-top:0;font-size:clamp(16px, 2.5vw, 18px);">Kdo jak odpovÄ›dÄ›l:</h4>
        
        {% if correct_responses %}
        <div style="margin-top:20px; padding:20px; background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%); border-radius:12px; border:3px solid var(--success);overflow-x:auto;box-shadow:var(--shadow);">
          <h5 style="margin-top:0; color:#065f46;font-size:18px;">âœ… SprÃ¡vnÄ› odpovÄ›dÄ›li:</h5>
          <table class="results-table">
            <thead>
              <tr style="border-bottom:2px solid #4CAF50;">
                <th>ÃšÄastnÃ­k</th>
                <th>OdpovÄ›Ä</th>
              </tr>
            </thead>
            <tbody>
              {% for response in correct_responses %}
              <tr style="border-bottom:1px solid #c8e6c9;">
                <td>{{ response.participant.display_name }}</td>
                <td>{{ response.answer.text }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
        
        {% if wrong_responses %}
        <div style="margin-top:20px; padding:20px; background:linear-gradient(135deg,#fee2e2 0%,#fecaca 100%); border-radius:12px; border:3px solid var(--error);overflow-x:auto;box-shadow:var(--shadow);">
          <h5 style="margin-top:0; color:#991b1b;font-size:18px;">âŒ Å patnÄ› odpovÄ›dÄ›li:</h5>
          <table class="results-table">
            <thead>
              <tr style="border-bottom:2px solid #f44336;">
                <th>ÃšÄastnÃ­k</th>
                <th>OdpovÄ›Ä</th>
              </tr>
            </thead>
            <tbody>
              {% for response in wrong_responses %}
              <tr style="border-bottom:1px solid #ffcdd2;">
                <td>{{ response.participant.display_name }}</td>
                <td>{{ response.answer.text }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </div>
      {% endif %}
      
      {% if all_answered or remaining == 0 %}
        <div style="margin-top:24px; padding-top:24px; border-top:3px solid var(--border);">
          {% if next_exists %}
            <a href="{% url 'session_start_question' session.hash qrun.order|add:1 %}" 
               class="btn primary success" style="display:block;text-align:center;padding:16px;font-size:18px;">
              â¡ï¸ PÅ™ejÃ­t na dalÅ¡Ã­ otÃ¡zku
            </a>
          {% else %}
            <a href="{% url 'session_finish' session.hash %}" 
               class="btn primary danger" style="display:block;text-align:center;padding:16px;font-size:18px;">
              ğŸ UkonÄit sezenÃ­
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% else %}
    {% if not question_started %}
      <div style="margin:24px 0; padding:20px; background:linear-gradient(135deg,#fef3c7 0%,#fde68a 100%); border-radius:12px; border:3px solid var(--warning);box-shadow:var(--shadow);">
        <p style="margin:0;font-size:18px;font-weight:600;color:#92400e;"><strong>â¸ï¸ OtÃ¡zka jeÅ¡tÄ› nebÄ›Å¾Ã­.</strong> PoÄkejte, aÅ¾ uÄitel spustÃ­ otÃ¡zku.</p>
      </div>
    {% elif has_answered %}
      <div style="margin:24px 0; padding:20px; background:linear-gradient(135deg,#e0e7ff 0%,#c7d2fe 100%); border-radius:12px; border:3px solid var(--primary);box-shadow:var(--shadow);">
        <p style="margin:0;font-size:18px;font-weight:600;color:#3730a3;">âœ… OdpovÄ›Ä pÅ™ijata. ÄŒekejte, neÅ¾ odpovÃ­ ostatnÃ­ studenti nebo uÄitel spustÃ­ dalÅ¡Ã­ otÃ¡zku.</p>
      </div>
    {% else %}
    <form action="{% url 'session_submit_answer' session.hash qrun.order %}" method="post" style="margin-top:24px;">
      {% csrf_token %}
      <ul style="list-style:none;padding:0;display:flex;flex-direction:column;gap:16px;">
        {% for a in qrun.question.answers.all %}
          <li style="margin:0;">
            <label class="answer-label">
              <input type="radio" name="answer_id" value="{{ a.id }}" required>
              <span>{{ a.text }}</span>
            </label>
          </li>
        {% endfor %}
      </ul>
      <button type="submit" class="btn primary" style="margin-top:24px;width:100%;padding:18px;font-size:18px;font-weight:bold;">ğŸ“¤ Odeslat odpovÄ›Ä</button>
    </form>
    {% endif %}
  {% endif %}
</div>
{% endblock %}


