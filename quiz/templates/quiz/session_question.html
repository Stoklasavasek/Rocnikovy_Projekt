{% extends "base.html" %}
{% load quiz_tags %}
{% block content %}
<div class="container quiz-container">
  <h1 class="quiz-title">{{ session.quiz.title }}</h1>
  {% if qrun.question.image %}
    <div class="question-image">
      <img src="{{ qrun.question.image.url }}" alt="Obrázek k otázce">
    </div>
  {% endif %}
  <h2 class="quiz-question">Otázka {{ qrun.order }}: {{ qrun.question.text }}</h2>
  {% if remaining %}
    <p class="timer-display">Zbývající čas: <span class="remaining-time">{{ remaining }}</span> s</p>
  {% endif %}

  <script>
    (function() {
      // Timer
      const remainingEl = document.querySelector('.remaining-time');
      let timerInterval = null;
      
      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }
      window.stopTimerIfRunning = stopTimer;
      
      if (remainingEl) {
        let currentTime = parseInt(remainingEl.textContent.trim()) || 0;
        {% if not is_host and has_answered %}
        stopTimer();
        {% elif not is_host or not all_answered %}
        timerInterval = setInterval(() => {
          if (currentTime > 0) {
            remainingEl.textContent = --currentTime;
          } else {
            stopTimer();
            {% if not is_host %}
            const form = document.getElementById('answer-form');
            const msg = document.getElementById('time-over-message');
            if (form) form.classList.add('time-over-hidden');
            if (msg) msg.classList.remove('time-over-hidden');
            {% endif %}
          }
        }, 1000);
        {% endif %}
      }
      
      // Socket.IO pro studenty
      {% if not is_host %}
      const hash = "{{ session.hash }}";
      const currentOrder = {{ qrun.order }};
      const studentStatusUrl = "{% url 'session_status' session.hash %}";
      const studentResultsUrl = "{% url 'session_results' session.hash %}";
      
      function createFallback() {
        return setInterval(async () => {
          try {
            const res = await fetch(studentStatusUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
            if (res.ok) {
              const data = await res.json();
              if (data.state === 'finished') {
                clearInterval(this);
                window.location.href = studentResultsUrl;
              } else if (data.state === 'question' && data.order !== currentOrder) {
                clearInterval(this);
                window.location.href = "/session/" + hash + "/q/" + data.order + "/";
              }
            }
          } catch (e) {}
        }, 2000);
      }
      
      if (typeof io === 'undefined') {
        createFallback();
        return;
      }
      
      const socket = io('http://localhost:8001', {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 500,
        reconnectionAttempts: 10
      });
      
      socket.on('disconnect', createFallback);
      socket.on('connect', () => socket.emit('join_session', {hash: hash}));
      if (socket.connected) socket.emit('join_session', {hash: hash});
      
      socket.on('session_state', (data) => {
        if (data.state === 'finished') {
          window.location.href = studentResultsUrl;
        } else if (data.state === 'question' && data.order !== currentOrder) {
          window.location.href = "/session/" + hash + "/q/" + data.order + "/";
        } else if (data.state === 'question' && !document.querySelector('form[action*="submit"]')) {
          {% if not has_answered %}
          location.reload();
          {% endif %}
        }
      });
      {% endif %}
    })();
  </script>

  {% if is_host %}
    <div class="card pad stats-card">
      <h3>Statistiky odpovědí</h3>
      <p><strong>Odpovědělo: <span class="answered-count stats-badge" id="answered-count">{{ answered_count }}</span> / <span class="stats-badge" id="total-participants">{{ total_participants }}</span></strong></p>
      
      {% if all_answered or time_over %}
      <div class="stats-section">
        <h4>Výsledky podle odpovědí:</h4>
        <ul class="stats-list">
          {% for answer in qrun.question.answers.all %}
          {% with stats=answer_stats|get_item:answer.id %}
          <li data-answer-id="{{ answer.id }}" class="answer-item {% if answer.is_correct %}correct{% else %}wrong{% endif %}">
            <div class="stats-item-wrapper">
              <div class="stats-item-text">
                <strong>{% if answer.is_correct %}✓{% else %}✗{% endif %} {{ answer.text }}</strong>
              </div>
              <div class="stats-number {% if answer.is_correct %}correct{% else %}wrong{% endif %}" data-answer-id="{{ answer.id }}">
                {% if stats %}{{ stats.count }}{% else %}0{% endif %}
              </div>
            </div>
          </li>
          {% endwith %}
          {% endfor %}
        </ul>
      </div>
      {% else %}
      <div class="stats-section waiting">
        <h4>Průběžné výsledky:</h4>
        <ul class="stats-list">
          {% for answer in qrun.question.answers.all %}
          {% with stats=answer_stats|get_item:answer.id %}
          <li data-answer-id="{{ answer.id }}" class="answer-item waiting">
            <div class="stats-item-wrapper">
              <div class="stats-item-text"><strong>{{ answer.text }}</strong></div>
              <div class="stats-number wrong" data-answer-id="{{ answer.id }}">
                {% if stats %}{{ stats.count }}{% else %}0{% endif %}
              </div>
            </div>
          </li>
          {% endwith %}
          {% endfor %}
        </ul>
        <p class="waiting-message">Čekáme na odpovědi všech účastníků...</p>
      </div>
      {% endif %}
      
      <div>
        <h4 class="participants-table-header">Kdo jak odpověděl:</h4>
        <div class="participants-table-wrapper">
          <table class="results-table">
            <thead>
              <tr class="table-header-row">
                <th>Účastník</th>
                <th>Odpověď</th>
                <th>Stav</th>
              </tr>
            </thead>
            <tbody>
              {% for p in participants %}
              {% with resp=participant_responses|get_item:p.id %}
              <tr class="table-data-row {% if all_answered or time_over %}{% if resp and resp.is_correct %}correct-answer-row{% elif resp and not resp.is_correct %}wrong-answer-row{% endif %}{% endif %}">
                <td class="table-cell">{{ p.display_name }}</td>
                <td class="table-cell">{% if resp %}{{ resp.answer.text }}{% else %}Neodpověděl{% endif %}</td>
                <td class="table-cell">
                  {% if resp %}
                    {% if all_answered or time_over %}
                      {% if resp.is_correct %}Správně ✓{% else %}Špatně ✗{% endif %}
                    {% else %}
                      Odpověděl
                    {% endif %}
                  {% else %}
                    Neodpověděl
                  {% endif %}
                </td>
              </tr>
              {% endwith %}
              {% empty %}
              <tr><td colspan="3" class="table-cell">Žádní účastníci.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="session-actions">
        {% if next_exists %}
          <a href="{% url 'session_start_question' session.hash qrun.order|add:1 %}" class="btn primary success session-action-btn">
            Přejít na další otázku
          </a>
        {% else %}
          <a href="{% url 'session_finish' session.hash %}" class="btn primary danger session-action-btn">
            Ukončit sezení
          </a>
        {% endif %}
      </div>
    </div>
  {% else %}
    {% if not question_started %}
      <div class="status-message warning">
        <p><strong>⏸️ Otázka ještě neběží.</strong> Počkejte, až učitel spustí otázku.</p>
      </div>
    {% elif has_answered %}
      <div class="status-message info">
        <p>Odpověď přijata. Čekejte, než odpoví ostatní studenti nebo učitel spustí další otázku.</p>
      </div>
      {% if current_response %}
        <div class="points-display">
          <div class="points-current">
            <div class="points-label">Body za tuto otázku:</div>
            <div class="points-value">{{ current_points }}</div>
            {% if current_response.is_correct %}
              <div class="points-status points-correct">✓ Správně</div>
            {% else %}
              <div class="points-status points-wrong">✗ Špatně (0 bodů)</div>
            {% endif %}
          </div>
          <div class="points-total">
            <div class="points-label">Celkové body:</div>
            <div class="points-value-large">{{ total_points }}</div>
          </div>
        </div>
      {% endif %}
    {% elif time_over %}
      <div class="status-message error">
        <p>Čas na odpověď vypršel. Neodpověděli jste. Čekejte, než učitel spustí další otázku.</p>
      </div>
    {% else %}
    <form action="{% url 'session_submit_answer' session.hash qrun.order %}" method="post" class="answer-form" id="answer-form">
      {% csrf_token %}
      <ul class="answer-list">
        {% for a in qrun.question.answers.all %}
          <li>
            <label class="answer-label">
              <input type="radio" name="answer_id" value="{{ a.id }}" required>
              <span>{{ a.text }}</span>
            </label>
          </li>
        {% endfor %}
      </ul>
      <button type="submit" class="btn primary submit-btn-full">Odeslat odpověď</button>
    </form>
    <div id="time-over-message" class="status-message error time-over-hidden">
      <p>Čas na odpověď vypršel. Neodpověděli jste. Čekejte, než učitel spustí další otázku.</p>
    </div>
    <script>
      document.getElementById('answer-form')?.addEventListener('submit', function() {
        if (window.stopTimerIfRunning) window.stopTimerIfRunning();
      });
    </script>
    {% endif %}
  {% endif %}
</div>

{% if is_host %}
<script>
(function() {
  let lastCount = {{ answered_count }};
  let allAnswered = {{ all_answered|yesno:"true,false" }};
  let timeOver = {{ time_over|yesno:"true,false" }};
  const order = {{ qrun.order }};
  const statusUrl = "{% url 'session_status' session.hash %}";
  const resultsUrl = "{% url 'session_results' session.hash %}";
  
  function updateStats() {
    fetch(statusUrl).then(r => r.ok ? r.json() : null).then(d => {
      if (!d) return;
      if (d.state === 'question' && d.order === order) {
        if (d.answered_count !== undefined && d.answered_count !== lastCount) {
          lastCount = d.answered_count;
          const countEl = document.getElementById('answered-count');
          if (countEl) countEl.textContent = d.answered_count;
          if (d.answer_stats) {
            for (const aid in d.answer_stats) {
              const statEl = document.querySelector('.stats-number[data-answer-id="' + aid + '"]');
              if (statEl) statEl.textContent = d.answer_stats[aid];
            }
          }
        }
        if (d.all_answered && !allAnswered) {
          allAnswered = true;
          setTimeout(() => location.reload(), 1000);
        }
        if (d.remaining !== undefined && d.remaining <= 0 && !timeOver) {
          timeOver = true;
          setTimeout(() => location.reload(), 500);
        }
      } else if (d.state === 'finished') {
        window.location.href = resultsUrl;
      }
    }).catch(() => {});
  }
  updateStats();
  setInterval(updateStats, 1000);
})();
</script>
{% endif %}

{% endblock %}
