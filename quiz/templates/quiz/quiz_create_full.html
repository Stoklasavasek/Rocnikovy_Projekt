{% extends "base.html" %}
{% load static %}

{% block body_class %}template-quiz-create-full{% endblock %}

{% block content %}
<div class="quiz-form-container">
  <h1>{% if quiz %}Upravit kvíz{% else %}Vytvořit nový kvíz{% endif %}</h1>
  <p class="quiz-form-description">{% if quiz %}Upravte kvíz s otázkami a odpověďmi.{% else %}Vytvořte kvíz s otázkami a odpověďmi najednou.{% endif %} Můžete přidat více otázek kliknutím na tlačítko "Přidat otázku".</p>
  
  <form method="post" id="quiz-form" enctype="multipart/form-data" action="{% if quiz %}{% url 'quiz_update' quiz.id %}{% else %}{% url 'quiz_create' %}{% endif %}">
    {% csrf_token %}
    
    <div class="quiz-title-input-wrapper">
      <label for="quiz_title" class="quiz-title-label">Název kvízu:</label>
      <input type="text" id="quiz_title" name="quiz_title" required 
             placeholder="Např. Matematika - Zlomky" 
             class="quiz-title-input"
             value="{{ quiz_title }}">
    </div>

    <div id="questions-container"></div>
    
    {% if questions_data %}
    <script id="questions-data" type="application/json">{{ questions_data|safe }}</script>
    {% endif %}
    
    <div class="quiz-form-add-question">
      <button type="button" id="add-question-btn" class="add-question-btn">+ Přidat otázku</button>
    </div>
    
    <div class="quiz-form-actions">
      <button type="submit" class="quiz-submit-btn">
        {% if quiz %}Uložit změny{% else %}Vytvořit kvíz{% endif %}
      </button>
      <a href="{% url 'quiz_list' %}" class="quiz-cancel-link">Zrušit</a>
    </div>
  </form>
</div>

<script>
let questionIndex = 0;

function addQuestion() {
  const container = document.getElementById('questions-container');
  const questionDiv = document.createElement('div');
  questionDiv.className = 'question-block';
  questionDiv.dataset.questionIndex = questionIndex;
  
  const currentQIndex = questionIndex;
  questionDiv.innerHTML = `
    <div class="question-header">
      <h3>Otázka ${questionIndex + 1}</h3>
      <button type="button" class="remove-question-btn">Smazat otázku</button>
    </div>
    
    <div class="question-field">
      <label>Text otázky:</label>
      <input type="text" name="question_${questionIndex}_text" required placeholder="Zadejte text otázky">
    </div>
    
    <div class="question-field">
      <label>Obrázek k otázce (volitelné):</label>
      <input type="file" name="question_${questionIndex}_image" accept="image/*">
      <p>Zobrazí se u této otázky studentům.</p>
    </div>
    
    <div class="question-field">
      <label>Čas na odpověď (sekundy):</label>
      <input type="number" name="question_${questionIndex}_duration" min="5" max="300" value="20" required>
      <p>Minimálně 5 sekund, maximálně 300 sekund (5 minut).</p>
    </div>
    
    <div class="quiz-form-answers-section">
      <label class="quiz-form-answers-label">Odpovědi:</label>
      <div class="answers-container">
        ${createAnswerHTML(currentQIndex, 0)}${createAnswerHTML(currentQIndex, 1)}${createAnswerHTML(currentQIndex, 2)}${createAnswerHTML(currentQIndex, 3)}
      </div>
      <button type="button" class="add-answer-btn">+ Přidat odpověď</button>
    </div>
  `;
  
  container.appendChild(questionDiv);
  
  questionDiv.querySelector('.remove-question-btn').addEventListener('click', () => {
    questionDiv.remove();
    updateQuestionNumbers();
  });
  questionDiv.querySelector('.add-answer-btn').addEventListener('click', () => {
    const answersContainer = questionDiv.querySelector('.answers-container');
    answersContainer.appendChild(createAnswerDiv(currentQIndex, answersContainer.children.length));
  });
  
  questionIndex++;
  return questionDiv;
}

function createAnswerHTML(questionIdx, answerIdx) {
  return `<div class="answer-row"><input type="text" name="question_${questionIdx}_answer_${answerIdx}_text" placeholder="Text odpovědi"><label><input type="checkbox" name="question_${questionIdx}_answer_${answerIdx}_correct"><span>Správná</span></label><button type="button" class="remove-answer-btn">×</button></div>`;
}

function createAnswerDiv(questionIdx, answerIdx) {
  const div = document.createElement('div');
  div.className = 'answer-row';
  div.innerHTML = createAnswerHTML(questionIdx, answerIdx);
  div.querySelector('.remove-answer-btn').addEventListener('click', () => div.remove());
  return div;
}

function updateQuestionNumbers() {
  document.querySelectorAll('.question-block').forEach((q, index) => {
    q.querySelector('h3').textContent = `Otázka ${index + 1}`;
  });
}

function loadExistingQuestions() {
  const questionsDataScript = document.getElementById('questions-data');
  if (!questionsDataScript) {
    addQuestion();
    return;
  }
  try {
    const existingQuestions = JSON.parse(questionsDataScript.textContent);
    if (existingQuestions?.length > 0) {
      existingQuestions.forEach(qData => {
        const qDiv = addQuestion();
        const questionInput = qDiv.querySelector(`input[name^="question_"][name$="_text"]`);
        if (questionInput && qData.text) questionInput.value = qData.text;
        const durationInput = qDiv.querySelector(`input[name^="question_"][name$="_duration"]`);
        if (durationInput && qData.duration) durationInput.value = qData.duration;
        if (qData.answers?.length > 0) {
          const answersContainer = qDiv.querySelector('.answers-container');
          answersContainer.innerHTML = '';
          qData.answers.forEach((aData, aIdx) => {
            const answerDiv = createAnswerDiv(questionIndex - 1, aIdx);
            const answerInput = answerDiv.querySelector('input[type="text"]');
            const correctCheckbox = answerDiv.querySelector('input[type="checkbox"]');
            if (answerInput && aData.text) answerInput.value = aData.text;
            if (correctCheckbox && aData.is_correct) correctCheckbox.checked = true;
            answersContainer.appendChild(answerDiv);
          });
        }
      });
    } else {
      addQuestion();
    }
  } catch (e) {
    console.error('Chyba při načítání otázek:', e);
    addQuestion();
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('add-question-btn')?.addEventListener('click', addQuestion);
  loadExistingQuestions();
});
</script>
{% endblock %}
