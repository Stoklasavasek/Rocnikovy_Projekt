{% extends "base.html" %}
{% load wagtailcore_tags %}
{# Šablona pro lobby živého sezení - zobrazuje kód pro připojení, účastníky a otázky #}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-8 text-center">Lobby: {{ session.quiz.title }}</h1>
  {# Velký a výrazný kód pro připojení - učitel ho sdílí se studenty #}
  <div class="card-modern text-center mb-8">
    <p class="text-lg text-gray-600 dark:text-gray-400 mb-2">Kód pro připojení:</p>
    <strong class="text-5xl font-black text-gradient">{{ session.code }}</strong>
  </div>
  
  {# Sekce pro učitele (host) #}
  {% if is_host %}
    {# JavaScript pro automatickou aktualizaci počtu účastníků (pro učitele) #}
    <script>
      (function() {
        let lastCount = {{ session.participants.count }};
        setInterval(async () => {
          try {
            const res = await fetch("{% url 'session_status' session.hash %}", {headers: {'X-Requested-With': 'XMLHttpRequest'}});
            if (res.ok) {
              const data = await res.json();
              if (data.total_participants !== undefined && data.total_participants !== lastCount) location.reload();
            }
          } catch (e) {}
        }, 2000);
      })();
    </script>
    
    {# Seznam účastníků připojených k sezení #}
    <div class="card-modern mb-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Účastníci</h3>
      <ul class="grid grid-cols-2 md:grid-cols-3 gap-3">
        {% for p in session.participants.all %}
          <li class="p-3 bg-gray-100/50 dark:bg-gray-700/50 rounded-lg text-center text-gray-900 dark:text-white font-medium">{{ p.display_name }}</li>
        {% empty %}
          <li class="col-span-full p-3 text-center text-gray-500 dark:text-gray-400">Zatím nikdo</li>
        {% endfor %}
      </ul>
    </div>
    
    {# Seznam otázek v kvízu s možností spuštění #}
    <div class="card-modern mb-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Otázky</h3>
      <ol class="space-y-3">
        {% for qrun in session.question_runs.all %}
          <li class="flex justify-between items-center p-4 bg-gray-100/50 dark:bg-gray-700/50 rounded-lg">
            <span class="text-gray-900 dark:text-white font-medium">{{ qrun.question.text }}</span>
            {% if not qrun.starts_at %}
              <a href="{% url 'session_start_question' session.hash qrun.order %}" class="btn-primary px-4 py-2">Spustit</a>
            {% else %}
              <span class="text-green-600 dark:text-green-400 font-semibold">✓ spuštěno</span>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </div>
    
    {# Tlačítko pro ukončení sezení #}
    <div class="flex justify-center">
      <a href="{% url 'session_finish' session.hash %}" class="btn-danger px-6 py-3">Ukončit sezení</a>
    </div>
  {# Sekce pro studenty #}
  {% else %}
    {# Informace o přihlášeném studentovi #}
    <div class="card-modern mb-6 text-center">
      <p class="text-gray-600 dark:text-gray-400 mb-2">Přihlášen jako:</p>
      <strong class="text-2xl text-gray-900 dark:text-white">{{ participant.display_name }}</strong>
    </div>
    <div class="card-modern mb-6 text-center bg-green-50 dark:bg-green-900/30 border-2 border-green-200 dark:border-green-700">
      <p class="text-green-800 dark:text-green-200 font-semibold mb-2 text-lg">Úspěšně jste se připojili!</p>
      <p class="text-green-700 dark:text-green-300">Jakmile učitel spustí otázku, budete automaticky přesměrováni.</p>
    </div>
    
    {# JavaScript pro automatickou aktualizaci počtu účastníků (stejně jako u učitele) #}
    <script>
      (function() {
        const hash = "{{ session.hash }}";
        const statusUrl = "{% url 'session_status' session.hash %}";
        const resultsUrl = "{% url 'session_results' session.hash %}";
        let lastCount = {{ session.participants.count }};
        
        setInterval(async () => {
          try {
            const res = await fetch(statusUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
            if (res.ok) {
              const data = await res.json();
              if (data.state === 'finished') {
                window.location.href = resultsUrl;
              } else if (data.state === 'question' && data.order !== undefined) {
                window.location.href = "/session/" + hash + "/q/" + data.order + "/";
              } else if (data.total_participants !== undefined && data.total_participants !== lastCount) {
                location.reload();
              }
            }
          } catch (e) {}
        }, 2000);
      })();
    </script>
    
    {# Vzdělávací materiály před začátkem kvízu (pro studenty) #}
    {% if educational_materials_before %}
      <div class="card-modern mb-6" style="background: #1f2937 !important; border: 2px solid #374151 !important;">
        <h2 class="text-2xl font-bold mb-4" style="color: #f9fafb !important;">Vzdělávací materiály</h2>
        <p class="mb-4" style="color: #d1d5db !important;">Před začátkem kvízu si můžete prostudovat následující materiály:</p>
        <ul class="material-list">
          {% for material in educational_materials_before %}
            <li class="material-item pad-sm bg-card rounded my-2">
              <div class="material-header" onclick="toggleMaterialLobby({{ forloop.counter0 }})">
                <div>
                  <h3><a href="{% pageurl material %}" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">{{ material.title }}</a></h3>
                  <p class="text-muted">
                    Typ: {{ material.get_material_type_display }}
                    {% if material.video_file %}
                      | <a href="{{ material.video_file.url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">Video soubor ↗</a>
                    {% elif material.document_file %}
                      | <a href="{{ material.document_file.url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">Dokument ↗</a>
                    {% elif material.external_url %}
                      | <a href="{{ material.external_url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">Externí odkaz ↗</a>
                    {% endif %}
                  </p>
                </div>
                <span class="material-toggle" id="toggle-lobby-{{ forloop.counter0 }}">▼</span>
              </div>
              {% if material.content %}
                <div class="material-content my-2" id="content-lobby-{{ forloop.counter0 }}">
                  {{ material.content|richtext }}
                </div>
              {% endif %}
              {% if material.video_file %}
                <div class="material-content my-2" id="content-lobby-{{ forloop.counter0 }}">
                  <video controls style="width: 100%; max-width: 800px;">
                    <source src="{{ material.video_file.url }}" type="video/mp4">
                    Váš prohlížeč nepodporuje video tag.
                  </video>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    
    {# Seznam dalších účastníků (pro studenty) #}
    <div class="card-modern">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Další účastníci</h3>
      <ul class="grid grid-cols-2 md:grid-cols-3 gap-3">
        {% for p in session.participants.all %}
          <li class="p-3 rounded-lg text-center font-medium {% if p.id == participant.id %}bg-indigo-100 dark:bg-indigo-900/50 text-indigo-900 dark:text-indigo-200{% else %}bg-gray-100/50 dark:bg-gray-700/50 text-gray-900 dark:text-white{% endif %}">
            {{ p.display_name }}{% if p.id == participant.id %} <strong>(vy)</strong>{% endif %}
          </li>
        {% empty %}
          <li class="col-span-full p-3 text-center text-gray-500 dark:text-gray-400">Zatím jste sami</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  
  {% if not is_host and educational_materials_before %}
  <script>
  (function() {
    function toggle(prefix, index) {
      const content = document.getElementById(`content-${prefix}-${index}`);
      const toggle = document.getElementById(`toggle-${prefix}-${index}`);
      if (content && toggle) {
        const isHidden = content.style.display === 'none';
        content.style.display = isHidden ? 'block' : 'none';
        toggle.textContent = isHidden ? '▲' : '▼';
      }
    }
    window.toggleMaterialLobby = (index) => toggle('lobby', index);
  })();
  </script>
  {% endif %}
</div>
{% endblock %}
