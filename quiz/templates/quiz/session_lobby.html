{% extends "base.html" %}
{% block content %}
<div style="max-width:800px;margin:24px auto;padding:0 16px;">
  <h1>Lobby: {{ session.quiz.title }}</h1>
  <p>Kód pro připojení: <strong>{{ session.code }}</strong></p>
  
  {% if is_host %}
    {# Teacher view #}
    <script>
      // Automaticky refreshovat stránku učitele každé 2 sekundy, aby viděl nové účastníky
      (function() {
        let lastParticipantCount = {{ session.participants.count }};
        setInterval(async function() {
          try {
            const res = await fetch("{% url 'session_status' session.hash %}", { 
              headers: { 'X-Requested-With': 'XMLHttpRequest' } 
            });
            if (!res.ok) return;
            const data = await res.json();
            if (data.total_participants !== undefined && data.total_participants !== lastParticipantCount) {
              location.reload();
            }
          } catch (e) {
            // ignore
          }
        }, 2000); // Kontrolovat každé 2 sekundy
      })();
    </script>
    <h3>Účastníci</h3>
    <ul>
      {% for p in session.participants.all %}
        <li>{{ p.display_name }}</li>
      {% empty %}
        <li>Zatím nikdo</li>
      {% endfor %}
    </ul>
    <h3>Otázky</h3>
    <ol>
      {% for qrun in session.question_runs.all %}
        <li>
          {{ qrun.question.text }}
          {% if not qrun.starts_at %}
            — <a href="{% url 'session_start_question' session.hash qrun.order %}">Spustit</a>
          {% else %}
            — spuštěno
          {% endif %}
        </li>
      {% endfor %}
    </ol>
    <p>
      <a href="{% url 'session_finish' session.hash %}">Ukončit sezení</a>
    </p>
  {% else %}
    {# Student view #}
    <p>Přihlášen jako: <strong>{{ participant.display_name }}</strong></p>
    <div style="margin-top: 20px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
      <p>✅ Úspěšně jste se připojili!</p>
      <p>Jakmile učitel spustí otázku, budete automaticky přesměrováni.</p>
      <p><em>Pokud ještě žádná neběží, uvidíte tuto lobby.</em></p>
    </div>
    <script>
      function initSocketIO() {
        const hash = "{{ session.hash }}";
        
        if (typeof io === 'undefined') {
          setTimeout(initSocketIO, 100);
          return;
        }
        
        const socket = io('http://localhost:8001', {
          transports: ['websocket', 'polling'],
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionAttempts: 5
        });
        
        socket.on('connect', function() {
          socket.emit('join_session', {hash: hash});
        });
        
        socket.on('session_state', function(data) {
          if (data.state === 'finished') {
            window.location.href = "{% url 'session_results' session.hash %}";
            return;
          }
          if (data.state === 'question') {
            if (data.order !== undefined && data.order !== null) {
              window.location.href = "/session/" + hash + "/q/" + data.order + "/";
            }
            return;
          }
        });
        
        socket.on('disconnect', function() {
          const fallback = setInterval(async function() {
            try {
              const res = await fetch("{% url 'session_status' session.hash %}", { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
              if (!res.ok) return;
              const data = await res.json();
              if (data.state === 'finished') {
                clearInterval(fallback);
                window.location.href = "{% url 'session_results' session.hash %}";
              } else if (data.state === 'question') {
                clearInterval(fallback);
                window.location.href = "/session/" + hash + "/q/" + data.order + "/";
              }
            } catch (e) { 
              // ignore
            }
          }, 2000);
        });
      }
      
      // Spustit po načtení stránky
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSocketIO);
      } else {
        // Stránka už je načtená
        initSocketIO();
      }
    </script>
    <h3>Další účastníci</h3>
    <ul>
      {% for p in session.participants.all %}
        <li>{{ p.display_name }}{% if p.id == participant.id %} (vy){% endif %}</li>
      {% empty %}
        <li>Zatím jste sami</li>
      {% endfor %}
    </ul>
  {% endif %}
</div>
{% endblock %}

