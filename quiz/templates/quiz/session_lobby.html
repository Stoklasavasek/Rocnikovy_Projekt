{% extends "base.html" %}
{% load wagtailcore_tags %}
{# Šablona pro lobby živého sezení - zobrazuje kód pro připojení, účastníky a otázky #}

{% block content %}
<div class="container lobby-container">
  <h1 class="lobby-title">Lobby: {{ session.quiz.title }}</h1>
  {# Velký a výrazný kód pro připojení - učitel ho sdílí se studenty #}
  <div class="lobby-code">
    <p>Kód pro připojení:</p>
    <strong>{{ session.code }}</strong>
  </div>
  
  {# Sekce pro učitele (host) #}
  {% if is_host %}
    {# JavaScript pro automatickou aktualizaci počtu účastníků (pro učitele) #}
    <script>
      (function() {
        let lastCount = {{ session.participants.count }};
        setInterval(async () => {
          try {
            const res = await fetch("{% url 'session_status' session.hash %}", {headers: {'X-Requested-With': 'XMLHttpRequest'}});
            if (res.ok) {
              const data = await res.json();
              if (data.total_participants !== undefined && data.total_participants !== lastCount) location.reload();
            }
          } catch (e) {}
        }, 2000);
      })();
    </script>
    
    {# Seznam účastníků připojených k sezení #}
    <div class="card pad lobby-section">
      <h3 class="lobby-section-title">Účastníci</h3>
      <ul class="participants-grid">
        {% for p in session.participants.all %}
          <li class="participant-item">{{ p.display_name }}</li>
        {% empty %}
          <li class="participant-item participant-item-empty">Zatím nikdo</li>
        {% endfor %}
      </ul>
    </div>
    
    {# Seznam otázek v kvízu s možností spuštění #}
    <div class="card pad lobby-section">
      <h3 class="lobby-section-title">Otázky</h3>
      <ol class="questions-list">
        {% for qrun in session.question_runs.all %}
          <li class="question-item">
            <span class="question-text">{{ qrun.question.text }}</span>
            {% if not qrun.starts_at %}
              <a href="{% url 'session_start_question' session.hash qrun.order %}" class="btn primary question-start-btn">Spustit</a>
            {% else %}
              <span class="question-status">✓ spuštěno</span>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </div>
    
    {# Tlačítko pro ukončení sezení #}
    <p>
      <a href="{% url 'session_finish' session.hash %}" class="btn btn-danger">Ukončit sezení</a>
    </p>
  {# Sekce pro studenty #}
  {% else %}
    {# Informace o přihlášeném studentovi #}
    <p>Přihlášen jako: <strong>{{ participant.display_name }}</strong></p>
    <div class="card pad success-message">
      <p>Úspěšně jste se připojili!</p>
      <p>Jakmile učitel spustí otázku, budete automaticky přesměrováni.</p>
    </div>
    
    {# JavaScript pro real-time aktualizace pomocí Socket.IO s fallbackem na AJAX #}
    <script>
      (function() {
        const hash = "{{ session.hash }}";
        const statusUrl = "{% url 'session_status' session.hash %}";
        const resultsUrl = "{% url 'session_results' session.hash %}";
        
        {# Fallback funkce pro AJAX polling (když Socket.IO není dostupné) #}
        function createFallback() {
          return setInterval(async () => {
            try {
              const res = await fetch(statusUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
              if (res.ok) {
                const data = await res.json();
                if (data.state === 'finished') {
                  clearInterval(this);
                  window.location.href = resultsUrl;
                } else if (data.state === 'question' && data.order !== undefined) {
                  clearInterval(this);
                  window.location.href = "/session/" + hash + "/q/" + data.order + "/";
                }
              }
            } catch (e) {}
          }, 2000);
        }
        
        {# Inicializace Socket.IO pro real-time komunikaci #}
        function initSocketIO() {
          if (typeof io === 'undefined') {
            setTimeout(initSocketIO, 100);
            return;
          }
          const socket = io('http://localhost:8001', {transports: ['websocket', 'polling'], reconnection: true, reconnectionDelay: 1000, reconnectionAttempts: 5});
          socket.on('connect', () => socket.emit('join_session', {hash: hash}));
          socket.on('disconnect', createFallback);
          socket.on('session_state', (data) => {
            if (data.state === 'finished') window.location.href = resultsUrl;
            else if (data.state === 'question' && data.order !== undefined) window.location.href = "/session/" + hash + "/q/" + data.order + "/";
          });
        }
        (document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', initSocketIO) : initSocketIO());
      })();
    </script>
    
    {# Vzdělávací materiály před začátkem kvízu (pro studenty) #}
    {% if educational_materials_before %}
      <div class="educational-materials card pad my-4">
        <h2>Vzdělávací materiály</h2>
        <p class="text-muted">Před začátkem kvízu si můžete prostudovat následující materiály:</p>
        <ul class="material-list">
          {% for material in educational_materials_before %}
            <li class="material-item pad-sm bg-card rounded my-2">
              <div class="material-header" onclick="toggleMaterialLobby({{ forloop.counter0 }})">
                <div>
                  <h3><a href="{% pageurl material %}" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">{{ material.title }}</a></h3>
                  <p class="text-muted">
                    Typ: {{ material.get_material_type_display }}
                    {% if material.video_file %}
                      | <a href="{{ material.video_file.url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">Video soubor ↗</a>
                    {% elif material.document_file %}
                      | <a href="{{ material.document_file.url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">Dokument ↗</a>
                    {% elif material.external_url %}
                      | <a href="{{ material.external_url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); window.open(this.href, '_blank'); return false;">Externí odkaz ↗</a>
                    {% endif %}
                  </p>
                </div>
                <span class="material-toggle" id="toggle-lobby-{{ forloop.counter0 }}">▼</span>
              </div>
              {% if material.content %}
                <div class="material-content my-2" id="content-lobby-{{ forloop.counter0 }}">
                  {{ material.content|richtext }}
                </div>
              {% endif %}
              {% if material.video_file %}
                <div class="material-content my-2" id="content-lobby-{{ forloop.counter0 }}">
                  <video controls style="width: 100%; max-width: 800px;">
                    <source src="{{ material.video_file.url }}" type="video/mp4">
                    Váš prohlížeč nepodporuje video tag.
                  </video>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    
    {# Seznam dalších účastníků (pro studenty) #}
    <div class="card pad lobby-section lobby-section-margin">
      <h3 class="lobby-section-title">Další účastníci</h3>
      <ul class="participants-grid">
        {% for p in session.participants.all %}
          <li class="participant-item {% if p.id == participant.id %}current{% endif %} participant-item-small">
            {{ p.display_name }}{% if p.id == participant.id %} <strong>(vy)</strong>{% endif %}
          </li>
        {% empty %}
          <li class="participant-item participant-item-empty">Zatím jste sami</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  
  {% if not is_host and educational_materials_before %}
  <script>
  (function() {
    function toggle(prefix, index) {
      const content = document.getElementById(`content-${prefix}-${index}`);
      const toggle = document.getElementById(`toggle-${prefix}-${index}`);
      if (content && toggle) {
        const isHidden = content.style.display === 'none';
        content.style.display = isHidden ? 'block' : 'none';
        toggle.textContent = isHidden ? '▲' : '▼';
      }
    }
    window.toggleMaterialLobby = (index) => toggle('lobby', index);
  })();
  </script>
  {% endif %}
</div>
{% endblock %}
