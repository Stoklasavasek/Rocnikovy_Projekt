{% extends "base.html" %}
{% load wagtailcore_tags %}
{# Å ablona pro lobby Å¾ivÃ©ho sezenÃ­ - zobrazuje kÃ³d pro pÅ™ipojenÃ­, ÃºÄastnÃ­ky a otÃ¡zky #}

{% block content %}
<div class="container lobby-container">
  <h1 class="lobby-title">Lobby: {{ session.quiz.title }}</h1>
  {# VelkÃ½ a vÃ½raznÃ½ kÃ³d pro pÅ™ipojenÃ­ - uÄitel ho sdÃ­lÃ­ se studenty #}
  <div class="lobby-code">
    <p>KÃ³d pro pÅ™ipojenÃ­:</p>
    <strong>{{ session.code }}</strong>
  </div>
  
  {# Sekce pro uÄitele (host) #}
  {% if is_host %}
    {# JavaScript pro automatickou aktualizaci poÄtu ÃºÄastnÃ­kÅ¯ (pro uÄitele) #}
    <script>
      (function() {
        let lastCount = {{ session.participants.count }};
        setInterval(async () => {
          try {
            const res = await fetch("{% url 'session_status' session.hash %}", {headers: {'X-Requested-With': 'XMLHttpRequest'}});
            if (res.ok) {
              const data = await res.json();
              if (data.total_participants !== undefined && data.total_participants !== lastCount) location.reload();
            }
          } catch (e) {}
        }, 2000);
      })();
    </script>
    
    {# Seznam ÃºÄastnÃ­kÅ¯ pÅ™ipojenÃ½ch k sezenÃ­ #}
    <div class="card pad lobby-section">
      <h3 class="lobby-section-title">ÃšÄastnÃ­ci</h3>
      <ul class="participants-grid">
        {% for p in session.participants.all %}
          <li class="participant-item">{{ p.display_name }}</li>
        {% empty %}
          <li class="participant-item participant-item-empty">ZatÃ­m nikdo</li>
        {% endfor %}
      </ul>
    </div>
    
    {# Seznam otÃ¡zek v kvÃ­zu s moÅ¾nostÃ­ spuÅ¡tÄ›nÃ­ #}
    <div class="card pad lobby-section">
      <h3 class="lobby-section-title">OtÃ¡zky</h3>
      <ol class="questions-list">
        {% for qrun in session.question_runs.all %}
          <li class="question-item">
            <span class="question-text">{{ qrun.question.text }}</span>
            {% if not qrun.starts_at %}
              <a href="{% url 'session_start_question' session.hash qrun.order %}" class="btn primary question-start-btn">Spustit</a>
            {% else %}
              <span class="question-status">âœ“ spuÅ¡tÄ›no</span>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </div>
    
    {# TlaÄÃ­tko pro ukonÄenÃ­ sezenÃ­ #}
    <p>
      <a href="{% url 'session_finish' session.hash %}" class="btn btn-danger">UkonÄit sezenÃ­</a>
    </p>
  {# Sekce pro studenty #}
  {% else %}
    {# Informace o pÅ™ihlÃ¡Å¡enÃ©m studentovi #}
    <p>PÅ™ihlÃ¡Å¡en jako: <strong>{{ participant.display_name }}</strong></p>
    <div class="card pad success-message">
      <p>ÃšspÄ›Å¡nÄ› jste se pÅ™ipojili!</p>
      <p>Jakmile uÄitel spustÃ­ otÃ¡zku, budete automaticky pÅ™esmÄ›rovÃ¡ni.</p>
      <p><em>Pokud jeÅ¡tÄ› Å¾Ã¡dnÃ¡ nebÄ›Å¾Ã­, uvidÃ­te tuto lobby.</em></p>
    </div>
    
    {# JavaScript pro real-time aktualizace pomocÃ­ Socket.IO s fallbackem na AJAX #}
    <script>
      (function() {
        const hash = "{{ session.hash }}";
        const statusUrl = "{% url 'session_status' session.hash %}";
        const resultsUrl = "{% url 'session_results' session.hash %}";
        
        {# Fallback funkce pro AJAX polling (kdyÅ¾ Socket.IO nenÃ­ dostupnÃ©) #}
        function createFallback() {
          return setInterval(async () => {
            try {
              const res = await fetch(statusUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
              if (res.ok) {
                const data = await res.json();
                if (data.state === 'finished') {
                  clearInterval(this);
                  window.location.href = resultsUrl;
                } else if (data.state === 'question' && data.order !== undefined) {
                  clearInterval(this);
                  window.location.href = "/session/" + hash + "/q/" + data.order + "/";
                }
              }
            } catch (e) {}
          }, 2000);
        }
        
        {# Inicializace Socket.IO pro real-time komunikaci #}
        function initSocketIO() {
          if (typeof io === 'undefined') {
            setTimeout(initSocketIO, 100);
            return;
          }
          const socket = io('http://localhost:8001', {transports: ['websocket', 'polling'], reconnection: true, reconnectionDelay: 1000, reconnectionAttempts: 5});
          socket.on('connect', () => socket.emit('join_session', {hash: hash}));
          socket.on('disconnect', createFallback);
          socket.on('session_state', (data) => {
            if (data.state === 'finished') window.location.href = resultsUrl;
            else if (data.state === 'question' && data.order !== undefined) window.location.href = "/session/" + hash + "/q/" + data.order + "/";
          });
        }
        (document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', initSocketIO) : initSocketIO());
      })();
    </script>
    
    {# VzdÄ›lÃ¡vacÃ­ materiÃ¡ly pÅ™ed zaÄÃ¡tkem kvÃ­zu (pro studenty) #}
    {% if educational_materials_before %}
      <div class="educational-materials card pad my-4">
        <h2>ğŸ“š VzdÄ›lÃ¡vacÃ­ materiÃ¡ly</h2>
        <p class="text-muted">PÅ™ed zaÄÃ¡tkem kvÃ­zu si mÅ¯Å¾ete prostudovat nÃ¡sledujÃ­cÃ­ materiÃ¡ly:</p>
        <ul class="material-list">
          {% for material in educational_materials_before %}
            <li class="material-item pad-sm bg-card rounded my-2">
              <div class="material-header" onclick="toggleMaterialLobby({{ forloop.counter0 }})">
                <div>
                  <h3><a href="{% pageurl material %}" onclick="event.stopPropagation();">{{ material.title }}</a></h3>
                  <p class="text-muted">
                    Typ: {{ material.get_material_type_display }}
                    {% if material.external_url %}
                      | <a href="{{ material.external_url }}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">ExternÃ­ odkaz â†—</a>
                    {% endif %}
                  </p>
                </div>
                <span class="material-toggle" id="toggle-lobby-{{ forloop.counter0 }}">â–¼</span>
              </div>
              {% if material.content %}
                <div class="material-content my-2" id="content-lobby-{{ forloop.counter0 }}">
                  {{ material.content|richtext }}
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    
    {# Seznam dalÅ¡Ã­ch ÃºÄastnÃ­kÅ¯ (pro studenty) #}
    <div class="card pad lobby-section lobby-section-margin">
      <h3 class="lobby-section-title">DalÅ¡Ã­ ÃºÄastnÃ­ci</h3>
      <ul class="participants-grid">
        {% for p in session.participants.all %}
          <li class="participant-item {% if p.id == participant.id %}current{% endif %} participant-item-small">
            {{ p.display_name }}{% if p.id == participant.id %} <strong>(vy)</strong>{% endif %}
          </li>
        {% empty %}
          <li class="participant-item participant-item-empty">ZatÃ­m jste sami</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
  
  {% if not is_host and educational_materials_before %}
  <script>
  (function() {
    function toggle(prefix, index) {
      const content = document.getElementById(`content-${prefix}-${index}`);
      const toggle = document.getElementById(`toggle-${prefix}-${index}`);
      if (content && toggle) {
        const isHidden = content.style.display === 'none';
        content.style.display = isHidden ? 'block' : 'none';
        toggle.textContent = isHidden ? 'â–²' : 'â–¼';
      }
    }
    window.toggleMaterialLobby = (index) => toggle('lobby', index);
  })();
  </script>
  {% endif %}
</div>
{% endblock %}
