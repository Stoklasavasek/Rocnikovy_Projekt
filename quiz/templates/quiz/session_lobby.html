{% extends "base.html" %}
{# Šablona pro lobby živého sezení - zobrazuje kód pro připojení, účastníky a otázky #}

{% block content %}
<div class="container lobby-container">
  <h1 class="lobby-title">Lobby: {{ session.quiz.title }}</h1>
  {# Velký a výrazný kód pro připojení - učitel ho sdílí se studenty #}
  <div class="lobby-code">
    <p>Kód pro připojení:</p>
    <strong>{{ session.code }}</strong>
  </div>
  
  {# Sekce pro učitele (host) #}
  {% if is_host %}
    {# JavaScript pro automatickou aktualizaci počtu účastníků (pro učitele) #}
    <script>
      (function() {
        let lastCount = {{ session.participants.count }};
        setInterval(async () => {
          try {
            const res = await fetch("{% url 'session_status' session.hash %}", {headers: {'X-Requested-With': 'XMLHttpRequest'}});
            if (res.ok) {
              const data = await res.json();
              if (data.total_participants !== undefined && data.total_participants !== lastCount) location.reload();
            }
          } catch (e) {}
        }, 2000);
      })();
    </script>
    
    {# Seznam účastníků připojených k sezení #}
    <div class="card pad lobby-section">
      <h3 class="lobby-section-title">Účastníci</h3>
      <ul class="participants-grid">
        {% for p in session.participants.all %}
          <li class="participant-item">{{ p.display_name }}</li>
        {% empty %}
          <li class="participant-item participant-item-empty">Zatím nikdo</li>
        {% endfor %}
      </ul>
    </div>
    
    {# Seznam otázek v kvízu s možností spuštění #}
    <div class="card pad lobby-section">
      <h3 class="lobby-section-title">Otázky</h3>
      <ol class="questions-list">
        {% for qrun in session.question_runs.all %}
          <li class="question-item">
            <span class="question-text">{{ qrun.question.text }}</span>
            {% if not qrun.starts_at %}
              <a href="{% url 'session_start_question' session.hash qrun.order %}" class="btn primary question-start-btn">Spustit</a>
            {% else %}
              <span class="question-status">✓ spuštěno</span>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </div>
    
    {# Tlačítko pro ukončení sezení #}
    <p>
      <a href="{% url 'session_finish' session.hash %}" class="btn btn-danger">Ukončit sezení</a>
    </p>
  {# Sekce pro studenty #}
  {% else %}
    {# Informace o přihlášeném studentovi #}
    <p>Přihlášen jako: <strong>{{ participant.display_name }}</strong></p>
    <div class="card pad success-message">
      <p>Úspěšně jste se připojili!</p>
      <p>Jakmile učitel spustí otázku, budete automaticky přesměrováni.</p>
      <p><em>Pokud ještě žádná neběží, uvidíte tuto lobby.</em></p>
    </div>
    
    {# JavaScript pro real-time aktualizace pomocí Socket.IO s fallbackem na AJAX #}
    <script>
      (function() {
        const hash = "{{ session.hash }}";
        const statusUrl = "{% url 'session_status' session.hash %}";
        const resultsUrl = "{% url 'session_results' session.hash %}";
        
        {# Fallback funkce pro AJAX polling (když Socket.IO není dostupné) #}
        function createFallback() {
          return setInterval(async () => {
            try {
              const res = await fetch(statusUrl, {headers: {'X-Requested-With': 'XMLHttpRequest'}});
              if (res.ok) {
                const data = await res.json();
                if (data.state === 'finished') {
                  clearInterval(this);
                  window.location.href = resultsUrl;
                } else if (data.state === 'question' && data.order !== undefined) {
                  clearInterval(this);
                  window.location.href = "/session/" + hash + "/q/" + data.order + "/";
                }
              }
            } catch (e) {}
          }, 2000);
        }
        
        {# Inicializace Socket.IO pro real-time komunikaci #}
        function initSocketIO() {
          if (typeof io === 'undefined') {
            setTimeout(initSocketIO, 100);
            return;
          }
          const socket = io('http://localhost:8001', {transports: ['websocket', 'polling'], reconnection: true, reconnectionDelay: 1000, reconnectionAttempts: 5});
          socket.on('connect', () => socket.emit('join_session', {hash: hash}));
          socket.on('disconnect', createFallback);
          socket.on('session_state', (data) => {
            if (data.state === 'finished') window.location.href = resultsUrl;
            else if (data.state === 'question' && data.order !== undefined) window.location.href = "/session/" + hash + "/q/" + data.order + "/";
          });
        }
        (document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', initSocketIO) : initSocketIO());
      })();
    </script>
    
    {# Seznam dalších účastníků (pro studenty) #}
    <div class="card pad lobby-section lobby-section-margin">
      <h3 class="lobby-section-title">Další účastníci</h3>
      <ul class="participants-grid">
        {% for p in session.participants.all %}
          <li class="participant-item {% if p.id == participant.id %}current{% endif %} participant-item-small">
            {{ p.display_name }}{% if p.id == participant.id %} <strong>(vy)</strong>{% endif %}
          </li>
        {% empty %}
          <li class="participant-item participant-item-empty">Zatím jste sami</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</div>
{% endblock %}
